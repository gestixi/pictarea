/*! Pictarea v1.1.1 | Â©2016-2019 GestiXi | Licensed under the MIT license */
!function($){"use strict";$.fn.pictarea=function(options,parameters){return this.each(function(){var that=this,$this=$(this),data=$this.data('pictarea');if(this.tagName!=='IMG'){console.error("pictarea - ERROR: The element must be an img.");return}
if(!data){var didLoad=$this[0].complete,formattedOpt=$.extend({},$.fn.pictarea.defaults,typeof options=='object'&&options),loadFunc=function(){$this.data('pictarea',(data=new Pictarea(that,formattedOpt)));data.drawCanvas(formattedOpt)};if(didLoad){loadFunc.apply($this[0])}else{$this.on("load",loadFunc).attr("src",$this.attr("src"))}}else{if(typeof options=='string')data[options](parameters)}})}
$.fn.pictarea.defaults={normal:{fillStyle:'rgba(255,255,255,.4)',strokeStyle:'rgba(255,255,255,.8)',lineWidth:1},hover:{fillStyle:'rgba(255,255,255,.6)',strokeStyle:'#fff',lineWidth:2,shadowColor:'#fff',shadowBlur:10},active:{fillStyle:'rgba(255,255,255,.8)',strokeStyle:'#f00',lineWidth:2},disabled:{fillStyle:'rgba(0,0,0,.4)',strokeStyle:'transparent'},areaValueKey:'target',areaDisableKey:'disabled',maxSelections:1,rescaleOnResize:!1,};var Pictarea=function(img,options){var that=this;that.options=options;that.img=img;var $img=that.$img=$(img);that.src=$img.attr('src');that.imgWidth=img.naturalWidth||img.width;that.imgHeight=img.naturalHeight||img.height;var $img=this.$img,usemap=$img.attr('usemap');if(!usemap){console.error("pictarea - ERROR: The img element must have a usemap attribute.");return}
var absCss={position:'absolute',top:0,left:0,right:0,bottom:0},$map=this.$map=$('map[name="'+usemap.substr(1)+'"]'),$initialMap=this.$initialMap=$map.clone(),$parent=$('<div class="pictarea"></div>').css({position:'relative'}),$visibleImg=$img.clone().attr({id:null,class:'pictarea-img',usemap:null}).css(absCss),$canvas=this.createCanvas().css(absCss);$img.before($parent).css('opacity',0).remove();$parent.append($visibleImg);$parent.append($canvas);$parent.append($img);this.drawCanvas();$map.on('mouseover',function(evt){that.mouseover(evt)}).on('mouseout',function(evt){that.mouseout(evt)}).on('click touchstart',function(evt){that.select(evt);evt.preventDefault()});if(options.rescaleOnResize){$(window).resize(function(e){that.scheduleRedraw()})}}
$.fn.pictarea.Constructor=Pictarea;Pictarea.prototype={constructor:Pictarea,hovered:null,selection:null,value:null,createCanvas:function(){var $canvas=$('<canvas style="width:100%;height:100%;"></canvas>'),canvas=$canvas[0];this.canvas=canvas;this.$canvas=$canvas;return $canvas},drawCanvas:function(){var canvas=this.canvas;canvas.width=canvas.offsetWidth;canvas.height=canvas.offsetHeight;canvas.getContext("2d").clearRect(0,0,canvas.offsetWidth,canvas.offsetHeight);this.drawZones()},drawZones:function(){var that=this,$map=this.$map,$initialAreas=this.$initialMap.find('area');$map.find('area').each(function(index){that.drawZone(this,$initialAreas[index])})},drawZone:function(area,initialArea){var that=this,state='normal',context=this.canvas.getContext('2d'),$area=$(area),shape=$area.attr('shape').toLowerCase().substr(0,4);if(initialArea){var $initialArea=$(initialArea),initialCoords=$initialArea.attr('coords').split(','),factor=this.imgWidth/this.canvas.offsetWidth;for(var i=0;i<initialCoords.length;i++){initialCoords[i]=parseFloat(initialCoords[i])/factor}
$area.attr('coords',initialCoords.join(','))}
var coords=$area.attr('coords').split(',');for(var i=0;i<coords.length;i++){coords[i]=parseFloat(coords[i])}
context.save();this.drawShape(shape,coords);this.styleShape(area);context.restore()},drawShape:function(shape,coords){var context=this.canvas.getContext('2d');context.beginPath();if(shape==='rect'){context.rect(coords[0],coords[1],coords[2]-coords[0],coords[3]-coords[1])}else if(shape==='poly'){context.moveTo(coords[0],coords[1]);for(var i=2;i<coords.length;i+=2){context.lineTo(coords[i],coords[i+1])}}else if(shape==='circ'){context.arc(coords[0],coords[1],coords[2],0,Math.PI*2,!1)}
context.closePath()},styleShape:function(area){var context=this.canvas.getContext('2d'),options=this.options,areaDisableKey=options.areaDisableKey,style=options.normal;if(areaDisableKey&&area.hasAttribute(areaDisableKey)){style=options.disabled}else{if(area===this.hovered){style=$.extend({},style,options.hover)}
if(this.selection&&this.selection.indexOf(area)>-1){style=$.extend({},style,options.active)}}
$.extend(context,style);context.fill();context.stroke()},mouseover:function(evt){var area=evt.target,options=this.options;if(!area)return;var mouseoverEvent=$.Event('enterArea.pictarea',{originalEvent:evt,area:area,pictarea:this});this.$img.trigger(mouseoverEvent);if(mouseoverEvent.isDefaultPrevented())return;this.hovered=area;this.drawCanvas()},mouseout:function(evt){var area=evt.target;if(!area)return;var mouseoutEvent=$.Event('leaveArea.pictarea',{originalEvent:evt,area:area,pictarea:this});this.$img.trigger(mouseoutEvent);if(mouseoutEvent.isDefaultPrevented())return;this.hovered=null;this.drawCanvas()},select:function(evt){var area=evt.target,options=this.options,areaDisableKey=options.areaDisableKey;if(areaDisableKey&&area.hasAttribute(areaDisableKey))return;var areaValueKey=options.areaValueKey,selection=this.selection,value=null,selectEvent=$.Event('selectArea.pictarea',{originalEvent:evt,area:area,key:areaValueKey?area.getAttribute(areaValueKey):null,pictarea:this});this.$img.trigger(selectEvent);if(selectEvent.isDefaultPrevented())return;if(!selection)selection=[];var areaSelIndex=selection.indexOf(area),maxSelections=options.maxSelections;if(areaSelIndex===-1)selection.push(area);else selection.splice(areaSelIndex,1);while(maxSelections>=0&&selection.length>options.maxSelections){selection.shift()}
if(areaValueKey){if(maxSelections===1){if(selection[0]){value=selection[0].getAttribute(areaValueKey)}}else if(maxSelections>1){value=[];selection.forEach(function(item){var val=item.getAttribute(areaValueKey);if(val)value.push(val)})}}
this.selection=selection;this.value=value;this.drawCanvas();var changeEvent=$.Event('change.pictarea',{originalEvent:evt,area:area,selection:selection,value:value,pictarea:this});this.$img.trigger(changeEvent)},destroy:function(){this._isDestroyed=!0;this.$img.removeData('pictarea')},scheduleRedraw:function(){if(this._didScheduleScale)return;if(window.requestAnimationFrame){var that=this;this._didScheduleScale=!0;requestAnimationFrame(function(){that.drawCanvas()})}else{this.drawCanvas()}},selectAreas:function(areaValueKeys){var _this=this;if(!areaValueKeys){this.selection=null;this.drawCanvas(null)}else{if(typeof areaValueKeys==='string'&&areaValueKeys.includes(','))areaValueKeys=areaValueKeys.replace(/\s/g,'').split(',');else if(!Array.isArray(areaValueKeys))areaValueKeys=[areaValueKeys];areaValueKeys=areaValueKeys.map((item)=>item.toString());var areas=Array.prototype.slice.call(this.$map.get(0).areas).filter((item)=>areaValueKeys.includes(item[_this.options.areaValueKey]));this.selection=Array.prototype.slice.call(areas);this.drawCanvas()}},selectAll:function(){var areas=Array.prototype.slice.call(this.$map.get(0).areas);this.selection=Array.prototype.slice.call(areas);this.drawCanvas()},clearAll:function(){this.selectAreas(null)}}}(window.jQuery)